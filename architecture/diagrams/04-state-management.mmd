%%{init: {'theme':'forest'}}%%

stateDiagram-v2
    [*] --> Idle: Plugin loaded
    
    Idle --> Validating: User selects file
    Validating --> Processing: File valid
    Validating --> Error: File invalid
    
    Processing --> CheckingCache: Audio processed
    CheckingCache --> CacheHit: Found in cache
    CheckingCache --> Uploading: Not in cache
    
    CacheHit --> Formatting: Retrieved from cache
    
    Uploading --> Transcribing: Upload complete
    Transcribing --> Formatting: Text received
    Formatting --> Inserting: Text formatted
    Inserting --> Completed: Text inserted
    
    Processing --> Cancelled: User cancels
    Uploading --> Cancelled: User cancels
    Transcribing --> Cancelled: User cancels
    Formatting --> Cancelled: User cancels
    
    Uploading --> Error: Network error
    Transcribing --> Error: API error
    Inserting --> Error: Editor error
    
    Error --> Idle: User acknowledges
    Cancelled --> Idle: Reset
    Completed --> Idle: Reset
    
    state Processing {
        [*] --> ReadingFile
        ReadingFile --> ExtractingMetadata
        ExtractingMetadata --> ValidatingSize
        ValidatingSize --> PreparingUpload
        PreparingUpload --> [*]
    }
    
    state Error {
        [*] --> IdentifyingError
        IdentifyingError --> ValidationError: Invalid file
        IdentifyingError --> NetworkError: Connection issue
        IdentifyingError --> ApiError: API failure
        IdentifyingError --> QuotaError: Rate limited
        IdentifyingError --> AuthError: Invalid API key
        
        ValidationError --> ShowingError
        NetworkError --> ShowingError
        ApiError --> ShowingError
        QuotaError --> ShowingError
        AuthError --> ShowingError
        
        ShowingError --> LoggingError
        LoggingError --> [*]
    }
    
    state Transcribing {
        [*] --> SendingRequest
        SendingRequest --> WaitingResponse
        WaitingResponse --> ProcessingResponse
        ProcessingResponse --> [*]
        
        SendingRequest --> RetryingRequest: Failed
        RetryingRequest --> SendingRequest: Retry
        RetryingRequest --> [*]: Max retries
    }
    
    note right of Idle: Initial state\nReady for input
    note right of Processing: File validation\nand preparation
    note right of Transcribing: API communication\nwith retry logic
    note right of Error: Error handling\nand recovery
    note left of Completed: Success state\nText inserted
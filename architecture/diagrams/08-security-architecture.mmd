%%{init: {'theme':'dark'}}%%

graph TB
    subgraph "Security Layers"
        subgraph "Input Security"
            INPUT_VAL[Input Validation]
            FILE_VAL[File Validation]
            SIZE_CHECK[Size Checking]
            FORMAT_CHECK[Format Verification]
        end
        
        subgraph "Authentication & Authorization"
            API_KEY[API Key Management]
            KEY_STORE[Secure Key Storage]
            KEY_VALID[Key Validation]
            PERM[Permission Control]
        end
        
        subgraph "Data Protection"
            ENCRYPT[Encryption at Rest]
            TLS[TLS/HTTPS]
            SANITIZE[Data Sanitization]
            CACHE_SEC[Secure Cache]
        end
        
        subgraph "Network Security"
            HTTPS[HTTPS Only]
            CERT_VAL[Certificate Validation]
            TIMEOUT[Request Timeouts]
            RATE_LIMIT[Rate Limiting]
        end
    end
    
    subgraph "Threat Mitigation"
        subgraph "Attack Prevention"
            XSS[XSS Prevention]
            INJECTION[Injection Prevention]
            PATH_TRAV[Path Traversal Block]
            OVERFLOW[Buffer Overflow Protection]
        end
        
        subgraph "Error Handling"
            NO_LEAK[No Info Leakage]
            SAFE_ERR[Safe Error Messages]
            LOG_FILTER[Log Filtering]
        end
    end
    
    subgraph "Secure Components"
        SEC_API[Secure API Client]
        SEC_STORE[Secure Storage]
        SEC_LOG[Secure Logger]
        SEC_CACHE[Secure Cache]
    end
    
    subgraph "Security Monitoring"
        AUDIT[Audit Logging]
        ANOMALY[Anomaly Detection]
        ALERT_SYS[Alert System]
        METRICS_SEC[Security Metrics]
    end
    
    %% Input flow
    INPUT_VAL --> FILE_VAL
    FILE_VAL --> SIZE_CHECK
    SIZE_CHECK --> FORMAT_CHECK
    FORMAT_CHECK --> SANITIZE
    
    %% API Key flow
    API_KEY --> KEY_VALID
    KEY_VALID --> KEY_STORE
    KEY_STORE --> ENCRYPT
    
    %% Network flow
    TLS --> HTTPS
    HTTPS --> CERT_VAL
    CERT_VAL --> SEC_API
    SEC_API --> RATE_LIMIT
    
    %% Data flow
    SANITIZE --> SEC_STORE
    SEC_STORE --> ENCRYPT
    ENCRYPT --> SEC_CACHE
    
    %% Attack prevention
    XSS --> SANITIZE
    INJECTION --> INPUT_VAL
    PATH_TRAV --> FILE_VAL
    OVERFLOW --> SIZE_CHECK
    
    %% Error handling
    NO_LEAK --> SAFE_ERR
    SAFE_ERR --> LOG_FILTER
    LOG_FILTER --> SEC_LOG
    
    %% Monitoring
    SEC_LOG --> AUDIT
    AUDIT --> ANOMALY
    ANOMALY --> ALERT_SYS
    ALERT_SYS --> METRICS_SEC
    
    %% Security checks
    SEC_API -.->|Validates| CHECK1[✓ API Key encrypted<br/>✓ HTTPS only<br/>✓ Certificate pinning]
    SEC_STORE -.->|Ensures| CHECK2[✓ Encrypted storage<br/>✓ Access control<br/>✓ Secure deletion]
    SEC_CACHE -.->|Implements| CHECK3[✓ Memory protection<br/>✓ TTL enforcement<br/>✓ Secure eviction]
    
    style API_KEY fill:#ff6b6b,stroke:#ff4757,stroke-width:3px
    style ENCRYPT fill:#4834d4,stroke:#3742fa,stroke-width:3px
    style TLS fill:#00b894,stroke:#00cec9,stroke-width:3px
    style AUDIT fill:#fdcb6e,stroke:#f39c12,stroke-width:3px